<% content_for :page_title, @forum_topic.title %>

<% content_for :sidebar do %>
  <% if @monitoring %>
    <%= button_to 'Stop monitoring this topic', forum_forum_topic_monitorship_path(@forum, @forum_topic.id), 
                  :id => 'monitor_button', :remote => true, :method => :delete %>
  <% else %>  
    <%= button_to 'Monitor this topic', forum_forum_topic_monitorship_path(@forum, @forum_topic.id), 
                  :id => 'monitor_button', :remote => true %>
  <% end %>

  <div class="forum_sidebar_voices">
    <h5><%= I18n.t 'txt.voices', :default => 'Voices' %></h5>
    <ul>
      <% @forum_topic.voices.each do |user| %>
        <li><%= user.display_name %></li>
      <% end %>
    </ul>
  </div>
<% end %>

<% content_for :crumbs, forum_crumbs(@forum_topic.forum) %>

<div class="comment_section">

  <%= render(:partial => 'dm_forum/forums/forum_header', :object => @forum_topic.forum, :as => :forum) %>

  <h1 id="topic_title">
    <%= @forum_topic.title %>
    <% if @forum_topic.locked? %>
      <span>(<%= I18n.t 'txt.topic', :default => 'Topic' %> <%= I18n.t 'txt.locked', :default => 'locked' %>)</span>
    <% end %>
    <% if user_signed_in? %>
      <% if can? :edit, @forum_topic %>
        <span id="topic_mod">
          <%= link_to(I18n.t('txt.edit', :default => 'edit'), edit_forum_forum_topic_path(@forum, @forum_topic), :class => "utility") %> |
          <%= link_to(I18n.t('txt.delete', :default => 'delete'), forum_forum_topic_path(@forum, @forum_topic), :class => "utility", :method => :delete, :confirm => I18n.t('txt.views_topics.delete_sure', :default => 'Delete this topic forever?')) %>
        </span>
      <% end %>
    <% end %>
  </h1>

  <p class="subtitle">
    <%= I18n.t 'fms.count_comments', :count => @forum_topic.forum_comments.size, 
              :num => number_with_delimiter(@forum_topic.forum_comments.size) %>,
    <%= I18n.t 'fms.count_voices', :count => @forum_topic.voices.size, 
              :num => number_with_delimiter(@forum_topic.voices.size) %>
  </p>

  <%= render(:partial => 'comments_list') unless @forum_comments.empty?%>

  <% if user_signed_in? %>
    <% if @forum_topic.locked? %>
      <p class="topic_locked"><%= I18n.t 'txt.views_topics.locked_topic', :default => 'This topic is locked.' %></p>
    <% else %>
      <p><%= link_to I18n.t('txt.reply_to_topic', :default => 'Reply to topic'), "#reply", :class => "utility", :id => 'reply-link' %></p>

      <div id="comment_reply_form" class="comment_reply_form">
        <%= simple_form_for [@forum, @forum_topic, @forum_topic.forum_comments.new] do |f| %>
          <%= f.input :body, :as => :text, :label => I18n.t('txt.views_topics.body', :default => 'Body'), 
                          :input_html => {:rows => 10} %>
          <%= submit_or_cancel :save => I18n.t('txt.views_topics.save_reply', :default => 'Save reply'),
                :cancel_url => [@forum] %>
        <% end %>
      </div>
    <% end %>
  <% end %>
</div>

<script type='text/javascript'><!--//--><![CDATA[//><!--
if (history  && history.replaceState && $$('.pagination')) {
  Event.observe(window, 'popstate', function(event){
    if(event.state) new Ajax.Request("<%= @forum_topic.slug %>", {method: 'get', parameters: event.state})
  });
};
//--><!]]></script>
