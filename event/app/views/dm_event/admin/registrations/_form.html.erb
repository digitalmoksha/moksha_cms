<% content_for :content_title, "#{h(@registration.full_name)} <small>#{h(@workshop.title)}</small>".html_safe %>
<% content_for :content_title_extra do %>
  <%= page_header_buttons do %>
    <%= present(@registration).admin_status_label %>
    <%= link_to icon_label(:view, 'Registrations'), [:admin, @workshop], class: 'btn btn-xs btn-default' %>
  <% end %>
<% end %>

  <div class="row">
    <div class="col-md-7">
      <%= panel title: 'Registration Details' do %>
        <%= simple_form_for @registration, url: admin_registration_path,
              html: { class: 'form-horizontal' }, wrapper: :bs3_horizontal_form, wrapper_mappings: DmAdmin::FormWrapperMappings do |f| %>
        
          <%= subsection title: 'Prices' do %>
            <%= f.error_notification message: "Please review the problems below" %>

            <% if @workshop.workshop_prices.empty? %>
              <h5>No workshop prices / options defined</h5>
            <% else %>
              <div class="workshop_price_list">
                <%= f.input :workshop_price_id, collection: @workshop.workshop_prices.map { |r| [price_details(r), r.id] }  %>
              </div>

              <% if @registration.workshop_price && @registration.workshop_price.price %>
                <% discount_currency = @registration.workshop_price.price.currency.symbol %>

                <%= f.input :discount_value, error: false, label: 'Discount' do %>
                  <%= f.input_field :discount_value %>
                  <%= f.select :discount_use_percent, [['%', true], [discount_currency, false]], {}, {style: "width: 60px", class: "select optional"} %>
                <% end %>
            
              <% end %>
        
              <%= f.input :payment_comment, label: 'Comment', as: :text_full_width, rows: 3 %>
            <% end %>
          <% end %>

          <% unless @workshop.custom_field_defs.empty? %>
            <%= subsection title: 'Custom Fields' do %>
              <% f.object.build_missing_fields @workshop %>
              <%= f.simple_fields_for :custom_fields do |builder| %>
                <% field = builder.object %>
                <%= render "dm_core/admin/custom_fields/#{field.field_type}", field: field, f: builder %>
              <% end %>
            <% end %>
          <% end %>

          <%= subsection title: 'Payment Reminders' do %>
            <%= f.input :preferred_payment_reminder_hold_until, label: 'No reminder until', as: :string, input_html: {class: 'datepicker'},
                         hint: 'When sending reminders in batch, this persons reminder will not be sent unless after the specified date' %>
          <% end %>
          
          <%= submit_or_cancel cancel_url: admin_workshop_path(@workshop), delete_url: [:admin, @registration], delete_confirm: 'Are you sure you wish to delete this registration?  Any associated payments will also be deleted!' %>
        <% end %>
      <% end %>
    </div>
    <div class="col-md-5">
      <% toolbar = toolbar_btn(icons(:new), '#', data: { toggle: "modal", target: "#enter_new_payment"}, title: 'New Payment', class: "btn btn-link btn-icon") %>
      <%= panel body: false, title: 'Recorded Payments', toolbar: toolbar do %>
        <table class="table table-condensed table-gradient table-hover">
          <thead>
            <tr>
              <th width="75">Date</th>
              <th>Description</th>
              <th width="50">Paid</th>
              <th>Method</th>
              <th width="18"><%= icons(:edit) %></th>
            </tr>
          </thead>
          <tbody>
            <% @registration.payment_histories.order('created_on ASC').each do |payment| %>
              <tr>
                <td><%= format_date(payment.payment_date) %></td>
                <td><%= payment.item_ref %></td>
                <td><%= payment.total.format(no_cents_if_whole: true, symbol: true) %></td>
                <td><%= payment.payment_method %></td>
                <td>
                  <% if payment.user_profile #--- only allow editing of manual payments %>
                    <%= link_to(icons('icon-pencil3'), '#', data: { toggle: "modal", target: "#edit_payment_#{payment.id}"}, title: 'Edit Payment') %>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% end %>
      <%= link_to 'Customer Payment Page', @registration.payment_url, target: '_blank', class: 'btn btn-xs btn-default' %>
    </div>

  </div>

  <%= simple_form_for :payment_history, url: ajax_payment_admin_registration_path(@registration),
        html: { class: 'form-horizontal' }, wrapper: :bs3_horizontal_form, wrapper_mappings: DmAdmin::FormWrapperMappings do |f| %>
  
    <%= modal_dialog title: 'Enter New Payment', id: 'enter_new_payment', include_save: true do %>
      <% if @registration.workshop_price.nil? %>
        <p><em>They must be registered for some type of payment first</em></p>
      <% else %>

        <%= f.input :payment_date, label: 'Paid On', input_html: {class: 'datepicker', style: 'width: 150px'} %>
        <%= f.input :cost, label: 'Amount' do %>
          <%= f.input_field :cost, as: :string %>
          <%= f.select :total_currency, @registration.workshop_price.currency_list, {}, {style: "width: 60px", class: "select"} %>
        <% end %>

        <%= f.input :payment_method, label: 'Method', as: 'select', collection: WorkshopPrice::PAYMENT_METHODS, include_blank: false, input_html: {style: "width: 200px"} %>
        <%= f.input :item_ref, label: 'Description', required: false %>
        <%= f.input :bill_to_name, label: 'Payed By', required: false %>
        <%= f.input :receipt_requested, as: 'boolean', label: false, inline_label: 'Customer would like a receipt', required: false %>
      <% end %>
    <% end %>
  <% end %>

  <% @registration.payment_histories.order('created_on ASC').each do |payment_history| %>
    <% #--- only allow editing of manual payments %>
    <% if payment_history.user_profile %>
      <%= simple_form_for payment_history, url: ajax_edit_payment_admin_registration_path(locale: I18n.locale, id: @registration, payment_id: payment_history.id),
            html: { class: 'form-horizontal' }, wrapper: :bs3_horizontal_form, wrapper_mappings: DmAdmin::FormWrapperMappings do |f| %>

        <%= modal_dialog title: 'Enter New Payment', id: "edit_payment_#{payment_history.id}", include_save: true,
                         delete_url: ajax_delete_payment_admin_registration_path(locale: I18n.locale, id: @registration, payment_id: payment_history.id),
                         delete_msg: 'Are you sure you want to delete this payment?' do %>
          <%= f.input :payment_date, as: :string, label: 'Paid On', input_html: {class: 'datepicker', id: "payment_date_#{payment_history.id}", style: 'width: 150px', value: payment_history.payment_date.try(:to_date)} %>
          <%= f.input :cost, label: 'Amount' do %>
            <%= f.input_field :cost, as: :string %>
            <%= f.select :total_currency, @registration.workshop_price.currency_list, {}, {style: "width: 60px", class: "select"} %>
          <% end %>
          <%= f.input :payment_method, label: 'Method', as: 'select', collection: WorkshopPrice::PAYMENT_METHODS, include_blank: false, input_html: {style: "width: 200px"} %>
          <%= f.input :item_ref, label: 'Description', required: false %>
          <%= f.input :bill_to_name, label: 'Payed By', required: false %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>